<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Metaforge Map Data Scraper</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #0a0a0a;
      color: #ffffff;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #ff8c00;
      border-bottom: 2px solid #ff8c00;
      padding-bottom: 10px;
    }
    .instructions {
      background: #171717;
      border: 1px solid #262626;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .instructions h2 {
      color: #ff8c00;
      margin-top: 0;
    }
    .instructions ol {
      line-height: 1.8;
    }
    .instructions code {
      background: #262626;
      padding: 2px 6px;
      border-radius: 4px;
      color: #ff8c00;
    }
    .map-selector {
      margin: 20px 0;
    }
    .map-selector label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }
    .map-selector select {
      width: 100%;
      padding: 10px;
      background: #171717;
      border: 1px solid #262626;
      color: #ffffff;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      border-radius: 4px;
    }
    button {
      background: #ff8c00;
      color: #0a0a0a;
      border: none;
      padding: 12px 24px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
      margin: 10px 10px 10px 0;
    }
    button:hover {
      background: #ffa033;
    }
    button:disabled {
      background: #525252;
      cursor: not-allowed;
    }
    #status {
      margin: 20px 0;
      padding: 15px;
      background: #171717;
      border: 1px solid #262626;
      border-radius: 4px;
      min-height: 50px;
    }
    .success { color: #4ade80; }
    .error { color: #ef4444; }
    .info { color: #60a5fa; }
    #output {
      background: #171717;
      border: 1px solid #262626;
      border-radius: 4px;
      padding: 15px;
      margin: 20px 0;
      max-height: 600px;
      overflow-y: auto;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .copy-btn {
      background: #262626;
      color: #ffffff;
    }
    .copy-btn:hover {
      background: #404040;
    }
  </style>
</head>
<body>
  <h1>üó∫Ô∏è Metaforge Map Data Scraper</h1>
  
  <div class="instructions">
    <h2>Instructions:</h2>
    <ol>
      <li>Open <a href="https://metaforge.app/arc-raiders/map/dam" target="_blank" style="color: #ff8c00;">https://metaforge.app/arc-raiders/map/dam</a> in a new tab</li>
      <li>Wait for the map to fully load (you should see all markers)</li>
      <li>Open DevTools (F12)</li>
      <li>Go to the <strong>Console</strong> tab</li>
      <li>Copy and paste the script below into the console and press Enter:</li>
    </ol>
  </div>

  <div class="map-selector">
    <label for="mapSelect">Select Map to Generate Script For:</label>
    <select id="mapSelect">
      <option value="dam">Dam Battlegrounds</option>
      <option value="spaceport">Spaceport</option>
      <option value="buried-city">Buried City</option>
      <option value="blue-gate">The Blue Gate</option>
      <option value="stella-montis">Stella Montis</option>
    </select>
  </div>

  <button onclick="copyScript()">üìã Copy Console Script</button>
  <button onclick="showInstructions()">üìñ Show Detailed Instructions</button>

  <div id="status"></div>

  <h3>Console Script (Copy this to DevTools Console):</h3>
  <div id="output"></div>
  <button class="copy-btn" onclick="copyOutput()">üìã Copy Script to Clipboard</button>

  <script>
    const CONSOLE_SCRIPT = `
// Metaforge Map Data Extractor
// Run this in the browser console while viewing a Metaforge map

(function() {
  console.log('üîç Searching for map data...');
  
  // Method 1: Check for React Fiber data structures
  const findReactProps = (element) => {
    for (let key in element) {
      if (key.startsWith('__reactProps') || key.startsWith('__reactFiber')) {
        return element[key];
      }
    }
    return null;
  };

  // Method 2: Look for map markers in DOM
  const extractFromMarkers = () => {
    const markers = document.querySelectorAll('[class*="marker"], [class*="Marker"], .leaflet-marker-icon');
    console.log(\`Found \${markers.length} marker elements\`);
    
    const data = [];
    markers.forEach((marker, index) => {
      const props = findReactProps(marker);
      if (props) {
        data.push(props);
      }
    });
    return data;
  };

  // Method 3: Check window object for data
  const extractFromWindow = () => {
    const keys = Object.keys(window).filter(key => 
      key.toLowerCase().includes('map') || 
      key.toLowerCase().includes('marker') ||
      key.toLowerCase().includes('point') ||
      key.toLowerCase().includes('location')
    );
    console.log('Relevant window keys:', keys);
    return keys;
  };

  // Method 4: Check for Next.js data
  const extractFromNextData = () => {
    const nextDataScript = document.querySelector('#__NEXT_DATA__');
    if (nextDataScript) {
      try {
        const data = JSON.parse(nextDataScript.textContent);
        console.log('‚úÖ Found Next.js data:', data);
        return data;
      } catch (e) {
        console.error('Error parsing Next.js data:', e);
      }
    }
    return null;
  };

  // Method 5: Intercept network requests
  const originalFetch = window.fetch;
  const requests = [];
  
  window.fetch = function(...args) {
    const url = args[0];
    if (typeof url === 'string' && (url.includes('map') || url.includes('marker') || url.includes('point'))) {
      console.log('üåê Intercepted fetch:', url);
      requests.push(url);
    }
    return originalFetch.apply(this, args);
  };

  // Execute extraction methods
  console.log('\\n=== Method 1: React Props ===');
  const markerData = extractFromMarkers();
  
  console.log('\\n=== Method 2: Window Object ===');
  const windowKeys = extractFromWindow();
  
  console.log('\\n=== Method 3: Next.js Data ===');
  const nextData = extractFromNextData();
  
  console.log('\\n=== Method 4: Check for Leaflet Map ===');
  if (window.L && window.L.map) {
    console.log('Leaflet detected');
    // Try to find map instance
    const maps = document.querySelectorAll('.leaflet-container');
    maps.forEach((mapEl, i) => {
      console.log(\`Map \${i}:, mapEl\`);
      for (let key in mapEl) {
        if (key.startsWith('_leaflet')) {
          console.log(\`  Leaflet key: \${key}\`, mapEl[key]);
        }
      }
    });
  }

  // Try to find Redux store
  console.log('\\n=== Method 5: Redux Store ===');
  const reduxKeys = Object.keys(window).filter(k => k.toLowerCase().includes('redux') || k.toLowerCase().includes('store'));
  console.log('Redux-related keys:', reduxKeys);

  // Output results
  console.log('\\n\\nüìä EXTRACTION COMPLETE');
  console.log('Copy the relevant data above and paste into your scraper');
  
  // Attempt to create downloadable JSON
  const allData = {
    markerData,
    nextData,
    windowKeys,
    requests,
    timestamp: new Date().toISOString()
  };
  
  console.log('\\nüì• Complete data object (copy this):');
  console.log(JSON.stringify(allData, null, 2));
  
  // Create download link
  const dataStr = JSON.stringify(allData, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'metaforge-map-data.json';
  link.textContent = 'üíæ Click here to download extracted data as JSON';
  link.style.cssText = 'display:block;margin:20px 0;padding:15px;background:#ff8c00;color:#000;text-decoration:none;border-radius:4px;font-weight:bold;';
  document.body.insertBefore(link, document.body.firstChild);
  
  console.log('\\n‚úÖ Download link added to page!');
  
  return allData;
})();
`;

    function updateScript() {
      const select = document.getElementById('mapSelect');
      const mapId = select.value;
      const mapUrl = `https://metaforge.app/arc-raiders/map/${mapId}`;
      
      const customScript = CONSOLE_SCRIPT.replace(
        '// Run this in the browser console while viewing a Metaforge map',
        `// Map: ${mapId}\\n// URL: ${mapUrl}\\n// Run this in the browser console`
      );
      
      document.getElementById('output').textContent = customScript;
    }

    function copyScript() {
      copyOutput();
      showStatus('Script copied! Now paste it in the browser console on the Metaforge map page.', 'success');
    }

    function copyOutput() {
      const output = document.getElementById('output').textContent;
      navigator.clipboard.writeText(output).then(() => {
        showStatus('‚úÖ Copied to clipboard!', 'success');
      }).catch(err => {
        showStatus('‚ùå Failed to copy: ' + err, 'error');
      });
    }

    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = type;
    }

    function showInstructions() {
      alert(`Detailed Instructions:

1. Open https://metaforge.app/arc-raiders/map/dam in a new browser tab
2. Wait for the map to fully load (you should see markers on the map)
3. Press F12 to open Developer Tools
4. Click on the "Console" tab
5. Click the "Copy Console Script" button on this page
6. Paste the script into the Console and press Enter
7. The script will search for map data and create a download link
8. Click the download link to save the data as JSON
9. Copy the JSON file to your project's scraped-data folder

The script will try multiple methods to extract the data:
- React component props
- Next.js data
- Leaflet map objects
- Window variables
- Network requests

If one method doesn't work, try looking at the console output for clues about where the data is stored.`);
    }

    // Initialize
    document.getElementById('mapSelect').addEventListener('change', updateScript);
    updateScript();
    showStatus('Ready! Select a map and copy the console script.', 'info');
  </script>
</body>
</html>
